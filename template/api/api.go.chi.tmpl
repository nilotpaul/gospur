{{- if .Render.IsTemplates -}}
package api

import (
	"fmt"
	"html/template"
	"log"
	"net/http"
	"strings"

	"test/config"

	"github.com/go-chi/chi/v5"
	"github.com/go-chi/chi/v5/middleware"
)

var templates *Template

type ServerConfig struct {
	// Serving static assets from public dir.
	ServeStatic func(*chi.Mux)

	// LoadTemplates takes glob petterns and returns the executed templates.
	LoadTemplates func(...string) *template.Template
}

type APIServer struct {
	listenAddr string
	env        *config.EnvConfig
	ServerConfig
}

func NewAPIServer(env *config.EnvConfig, cfg ServerConfig) *APIServer {
	return &APIServer{
		listenAddr:   ":" + env.Port,
		env:          env,
		ServerConfig: cfg,
	}
}

type Template struct {
	templates *template.Template
	isDev     bool
}

func (t *Template) Render(w http.ResponseWriter, status int, name string, data any, layouts ...string) error {
	dataMap := map[string]any{"IsDev": t.isDev, "Page": name, "Ctx": data}

	w.Header().Set("Content-Type", "text/html; charset=utf-8")
	w.WriteHeader(status)

	layout := "Root.html"
	if len(layouts) > 0 {
		layout = layouts[0]
	}
	return t.templates.ExecuteTemplate(w, layout, dataMap)
}

// Start will run the API Server
// Any global middlewares like Logger should be registered here.
func (api *APIServer) Start() error {
	mux := chi.NewMux()
	templates = &Template{
		templates: api.LoadTemplates("web/*.html", "web/layouts/*.html"),
		isDev:     !api.env.IsProduction(),
	}

	// Global Middlewares
	api.registerGlobalMiddlewares(mux)

	// Routes
	r := NewRouter(api.env)
	r.RegisterRoutes(mux)

	// Static routes
	api.ServeStatic(mux)

	log.Printf("Visit http://localhost%s", api.listenAddr)

	return http.ListenAndServe(api.listenAddr, mux)
}

// Middlewares
func (api *APIServer) registerGlobalMiddlewares(mux *chi.Mux) {
	mux.Use(logger) // Logger should come before Recoverer
	mux.Use(middleware.Recoverer)
}

func logger(h http.Handler) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		// Skipping Logging of public assets.
		if strings.HasPrefix(r.URL.Path, "/public") {
			h.ServeHTTP(w, r)
			return
		}

		fmt.Print("\n")
		middleware.Logger(h).ServeHTTP(w, r)
	})
}
{{- else if .Render.IsSeperate -}}
package api

import (
	"log"
	"net/http"

	"{{ .ModPath }}/config"

	"github.com/go-chi/chi/v5"
	"github.com/go-chi/chi/v5/middleware"
)

type ServerConfig struct {
	// Serving static assets from web folder.
	ServeStatic func(*chi.Mux)
}

type APIServer struct {
	listenAddr string
	env        *config.EnvConfig
	ServerConfig
}

func NewAPIServer(env *config.EnvConfig, cfg ServerConfig) *APIServer {
	return &APIServer{
		listenAddr:   ":" + env.Port,
		env:          env,
		ServerConfig: cfg,
	}
}

// Start will run the API Server
// Any global middlewares like Logger should be registered here.
func (api *APIServer) Start() error {
	mux := chi.NewMux()

	// Global Middlewares
	api.registerGlobalMiddlewares(mux)

	// Routes
	r := NewRouter(api.env)
	r.RegisterRoutes(mux)
	
	// Static routes
	api.ServeStatic(mux)

	log.Printf("Visit http://localhost%s", api.listenAddr)

	return http.ListenAndServe(api.listenAddr, mux)
}

// Middlewares
func (api *APIServer) registerGlobalMiddlewares(mux *chi.Mux) {
	mux.Use(middleware.Logger) // Logger should come before Recoverer
	mux.Use(middleware.Recoverer)
}
{{- end -}}